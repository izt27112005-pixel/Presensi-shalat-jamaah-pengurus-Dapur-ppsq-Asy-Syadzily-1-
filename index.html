<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Absen Digital Anggota Dapur PPSQ Asy Syadzily 1</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#6C5CE7;       /* ungu elegan */
    --brand-2:#00C2A8;     /* teal cerah */
    --brand-3:#F7B500;     /* kuning aksen */
    --bg:#0f1226;          /* gelap elegan (bukan hitam) */
    --card:#161a39;
    --soft:#8E9AF0;
    --danger:#ef4444;
  }
  html,body{background:var(--bg); color:#e5e7eb; font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  /* Glow gradient background */
  .glow:before{
    content:"";
    position:absolute; inset:-60px;
    background: radial-gradient(800px 400px at 20% 0%, rgba(108,92,231,.25), transparent 60%),
                radial-gradient(800px 400px at 80% 40%, rgba(0,194,168,.18), transparent 60%),
                radial-gradient(600px 320px at 50% 100%, rgba(247,181,0,.18), transparent 60%);
    filter: blur(40px);
    z-index:-1;
  }
  /* Pretty switches */
  .pill{
    position:relative; display:inline-flex; align-items:center; gap:.5rem;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    padding:.4rem; border-radius:999px;
  }
  .pill button{
    border-radius:999px; padding:.4rem .9rem; font-weight:600;
  }
  .pill .active{
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    color:white; box-shadow:0 8px 24px rgba(108,92,231,.35), inset 0 0 0 1px rgba(255,255,255,.15);
  }
  /* Attendance chips (untuk input/admin) */
  .chip{ border-radius:999px; padding:.35rem .7rem; font-weight:700; cursor:pointer; transition:all .18s ease; border:1px solid rgba(255,255,255,.08)}
  .chip:hover{ transform:translateY(-1px); }
  .chip.selected{ box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.15)}
  .chip-hadir{ background:rgba(0,194,168,.18); color:#8FF4E7 }
  .chip-alpha{ background:rgba(239,68,68,.18); color:#fecaca }
  .chip-sakit{ background:rgba(247,181,0,.18); color:#FDE68A }
  .chip-izin{  background:rgba(108,92,231,.18); color:#c7d2fe }

  /* Badge mini untuk rekap per anggota (viewer) */
  .badge{ display:inline-block; font-weight:800; font-size:.75rem; line-height:1; padding:.45rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,.08) }
  .badge-hadir{ background:rgba(0,194,168,.18); color:#8FF4E7 }
  .badge-alpha{ background:rgba(239,68,68,.18); color:#fecaca }
  .badge-sakit{ background:rgba(247,181,0,.18); color:#FDE68A }
  .badge-izin{  background:rgba(108,92,231,.18); color:#c7d2fe }

  /* Row hover */
  .row:hover{ background:rgba(255,255,255,.03) }
  /* Card glass */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.1);
    border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  /* Avatar */
  .avatar{
    width:42px; height:42px; border-radius:999px; overflow:hidden; display:grid; place-items:center;
    border:2px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  }
  .avatar img{ width:100%; height:100%; object-fit:cover }
  .avatar span{ font-weight:800; color:#fff }
  /* Print */
  @media print{
    body{ background:white; color:#111827 }
    .no-print{ display:none !important }
    .card{ box-shadow:none; border:1px solid #e5e7eb; background:white }
    .chip{ border:1px solid #e5e7eb }
    .badge{ border:1px solid #e5e7eb }
  }
</style>

<!-- =====================
     Firebase module (Firestore helpers)
     ===================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCX-M-eNScPTqmtIOp7Zs1fFwkIg27VkF0",
    authDomain: "data-jamaah-dapur.firebaseapp.com",
    projectId: "data-jamaah-dapur",
    storageBucket: "data-jamaah-dapur.firebasestorage.app",
    messagingSenderId: "963461575071",
    appId: "1:963461575071:web:6f4e5dda0ed559b8178daa",
    measurementId: "G-1TYW7NZX90"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function saveDailyDoc(date, data) {
    try { await setDoc(doc(db, "absensi", date), data || {}); }
    catch (err) { console.error("Firestore saveDailyDoc error:", err); }
  }
  async function saveAllDaily(obj) {
    const ops = [];
    for (const date in obj) { ops.push(saveDailyDoc(date, obj[date])); }
    await Promise.all(ops);
  }
  async function loadDailyDoc(date) {
    try {
      const d = await getDoc(doc(db, "absensi", date));
      return d.exists() ? d.data() : null;
    } catch (err) {
      console.error("Firestore loadDailyDoc error:", err);
      return null;
    }
  }
  function watchDailyDoc(date, callback) {
    try {
      const unsub = onSnapshot(doc(db, "absensi", date), (docSnap) => {
        if (docSnap.exists()) { callback(docSnap.data()); }
        else { callback({}); }
      }, (err) => console.error("Firestore watch error:", err));
      return unsub;
    } catch (err) {
      console.error("Firestore watchDailyDoc error:", err);
      return null;
    }
  }
  window.firebaseHelpers = { saveDailyDoc, saveAllDaily, loadDailyDoc, watchDailyDoc };
</script>

</head>
<body>
  <div class="relative glow min-h-screen">
    <header class="max-w-7xl mx-auto px-6 pt-10">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
            absen digital anggota dapur ppsq asy Syadzily 1
          </h1>
          <p class="text-slate-300 mt-2">Ditandatangani ketua bidang, <span class="font-semibold text-white">Al Ghifary</span></p>
        </div>
        <div class="flex flex-wrap items-center gap-3 no-print">
          <div class="pill">
            <button id="btnViewer" class="active">Viewer</button>
            <button id="btnAdmin">Admin</button>
          </div>
          <input id="datePicker" type="date" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white" />
          <div class="pill">
            <button id="btnHari" class="active">Hari Ini</button>
            <button id="btnMinggu">Mingguan</button>
          </div>
          <button id="btnPrint" class="bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] text-white font-semibold px-4 py-2 rounded-xl shadow-lg hover:opacity-95 active:scale-[.98]">
            Cetak Rekap
          </button>
        </div>
      </div>
      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div class="card p-4">
          <div class="text-sm text-slate-300">Tanggal dipilih</div>
          <div id="infoTanggal" class="text-xl font-bold mt-1"></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-300">Status mode</div>
          <div id="infoMode" class="text-xl font-bold mt-1">Viewer (hanya lihat)</div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-300">Total anggota</div>
          <div id="infoAnggota" class="text-xl font-bold mt-1">0</div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-10">
      <div class="no-print flex items-center gap-2 mb-6 no-viewer">
        <div class="pill">
          <button id="tabNon" class="active">Non Sekolah</button>
          <button id="tabSekolah">Sekolah</button>
        </div>
        <span class="text-slate-300 text-sm">Kelompok anggota</span>
      </div>

      <section id="sectionHari" class="">
        <!-- Panel input harian (hanya admin) -->
        <div id="panelNon" class="card p-5 mb-8 no-viewer">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-extrabold">Non Sekolah</h2>
            <div class="text-slate-300">Shalat: Subuh • Dzuhur • Ashar • Maghrib • Isya</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[720px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Subuh</th>
                  <th class="py-3">Dzuhur</th>
                  <th class="py-3">Ashar</th>
                  <th class="py-3">Maghrib</th>
                  <th class="py-3">Isya</th>
                  <th class="py-3">Foto</th>
                </tr>
              </thead>
              <tbody id="tbodyNon"></tbody>
            </table>
          </div>
        </div>

        <div id="panelSekolah" class="card p-5 mb-8 hidden no-viewer">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-extrabold">Sekolah</h2>
            <div class="text-slate-300">Shalat: Subuh • Dzuhur • Ashar • Maghrib • Isya</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[720px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Subuh</th>
                  <th class="py-3">Dzuhur</th>
                  <th class="py-3">Ashar</th>
                  <th class="py-3">Maghrib</th>
                  <th class="py-3">Isya</th>
                  <th class="py-3">Foto</th>
                </tr>
              </thead>
              <tbody id="tbodySekolah"></tbody>
            </table>
          </div>
        </div>

        <!-- REKAP PER SHALAT DIHILANGKAN SESUAI ARAHAN -->

        <!-- Rekap Harian per Anggota (FORMAT BARU: status per shalat, berwarna) -->
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold">Rekap Harian per Anggota</h3>
          </div>
          <div id="rekapHarianAnggota" class="overflow-x-auto">
            <table class="w-full min-w-[720px]">
              <thead>
                <tr class="text-left text-slate-300 border-b border-white/10">
                  <th class="py-3">Anggota</th>
                  <th class="py-3">Subuh</th>
                  <th class="py-3">Dzuhur</th>
                  <th class="py-3">Ashar</th>
                  <th class="py-3">Maghrib</th>
                  <th class="py-3">Isya</th>
                </tr>
              </thead>
              <tbody id="tbodyHarianAnggota"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="sectionMinggu" class="hidden">
        <div class="card p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <h3 class="text-xl font-extrabold">Rekap Total Mingguan</h3>
            <div class="no-print flex items-center gap-3">
              <label class="text-slate-300">Mulai Minggu:</label>
              <input id="weekStart" type="date" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white" />
              <button id="btnHitungMinggu" class="bg-white/10 border border-white/10 px-4 py-2 rounded-xl hover:bg-white/20">Hitung</button>
            </div>
          </div>

          <div id="rekapMingguWrap" class="grid lg:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold">Non Sekolah</h4>
                <span id="sumNon" class="text-slate-300 text-sm">-</span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[680px]">
                  <thead>
                    <tr class="text-left text-slate-300 border-b border-white/10">
                      <th class="py-3">Anggota</th>
                      <th class="py-3">Hadir</th>
                      <th class="py-3">Alpha</th>
                      <th class="py-3">Sakit</th>
                      <th class="py-3">Izin</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyWeekNon"></tbody>
                </table>
              </div>
            </div>
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold">Sekolah</h4>
                <span id="sumSekolah" class="text-slate-300 text-sm">-</span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[680px]">
                  <thead>
                    <tr class="text-left text-slate-300 border-b border-white/10">
                      <th class="py-3">Anggota</th>
                      <th class="py-3">Hadir</th>
                      <th class="py-3">Alpha</th>
                      <th class="py-3">Sakit</th>
                      <th class="py-3">Izin</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyWeekSekolah"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-6 text-slate-300">
            Catatan: Perhitungan mingguan menjumlahkan semua shalat (5 waktu) selama 7 hari sejak tanggal mulai.
          </div>
        </div>
      </section>
    </main>

    <footer class="max-w-7xl mx-auto px-6 pb-12">
      <div class="card p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <div class="font-bold">Tertandatangani:</div>
          <div class="text-white text-lg font-extrabold">Al Ghifary</div>
          <div class="text-slate-300">Ketua Bidang</div>
        </div>
        <div id="storageNote" class="text-slate-400">Data disimpan di perangkat Anda (local). Gunakan Cetak untuk membagikan rekap.</div>
      </div>
    </footer>
  </div>

  <!-- Modals & FAB (tetap sama) -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-md bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Masuk sebagai Admin</h3>
      <p class="text-slate-300 mb-4">Masukkan PIN admin untuk mengedit data.</p>
      <input id="adminPinInput" type="password" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white mb-4" placeholder="PIN Admin" />
      <div class="flex flex-col gap-3">
        <div class="flex justify-end gap-3">
          <button id="cancelAdmin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Batal</button>
          <button id="confirmAdmin" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Masuk</button>
        </div>
        <button id="forgotPin" class="text-left text-sky-300 hover:text-sky-200">Lupa PIN?</button>
      </div>
    </div>
  </div>

  <div id="fotoModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-lg bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Tambah/Ubah Foto Anggota</h3>
      <p class="text-slate-300 mb-4">Pilih anggota lalu unggah foto. Foto disimpan di perangkat Anda.</p>
      <div class="grid md:grid-cols-2 gap-3 mb-4">
        <select id="fotoAnggotaSelect" class="bg-white/10 border border-white/10 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)] text-white"></select>
        <input id="fotoFile" type="file" accept="image/*" class="bg-white/10 border border-white/10 rounded-xl px-4 py-2 text-slate-200" />
      </div>
      <div class="flex items-center gap-3 mb-4">
        <button id="btnHapusFoto" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-red-300">Hapus Foto</button>
        <button id="btnSimpanFoto" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Simpan Foto</button>
        <div class="flex-1"></div>
        <button id="btnTutupFoto" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Tutup</button>
      </div>
      <div id="previewFoto" class="rounded-xl overflow-hidden border border-white/10 bg-white/5 grid place-items-center h-48 text-slate-300">
        Pratinjau foto akan muncul di sini
      </div>
    </div>
  </div>

  <div id="mainFabContainer" class="no-print fixed bottom-6 right-6 z-40 hidden">
    <div id="adminFab" class="hidden">
      <div class="card p-4 bg-[var(--card)]">
        <div class="flex flex-col gap-2">
          <button id="openAnggotaModal" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Kelola Anggota</button>
          <button id="openFotoModal" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Kelola Foto Anggota</button>
          <button id="exportData" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Ekspor Data</button>
          <button id="importData" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Impor Data</button>
          <button id="changePin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left">Ubah PIN Admin</button>
          <button id="logoutAdmin" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left text-red-300">Keluar Admin</button>
        </div>
      </div>
    </div>
    <button id="fabToggle" class="rounded-full bg-gradient-to-br from-[var(--brand)] to-[var(--brand-2)] w-14 h-14 shadow-xl grid place-items-center hover:opacity-95 active:scale-[.98]">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M12 13a1 1 0 0 1-1-1V6.5a1 1 0 1 1 2 0V12a1 1 0 0 1-1 1Zm0 4.75a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5Z"/></svg>
    </button>
  </div>

  <div id="anggotaModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
    <div class="card p-6 w-full max-w-lg bg-[var(--card)]">
      <h3 class="text-xl font-extrabold mb-2">Kelola Anggota</h3>
      <p class="text-slate-300 mb-4">Tambah atau hapus anggota dari daftar.</p>
      <div class="flex flex-col gap-4">
        <div class="p-4 rounded-xl border border-white/10 bg-white/5">
          <h4 class="font-bold mb-2">Tambah Anggota</h4>
          <input id="anggotaNamaTambah" type="text" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white mb-2" placeholder="Nama Anggota (huruf kecil)" />
          <div class="flex items-center gap-2">
            <select id="anggotaGrupTambah" class="flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white">
              <option value="non">Non Sekolah</option>
              <option value="sekolah">Sekolah</option>
            </select>
            <button id="btnTambahAnggota" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[var(--brand)] to-[var(--brand-2)] font-semibold">Tambah</button>
          </div>
        </div>

        <div class="p-4 rounded-xl border border-white/10 bg-white/5">
          <h4 class="font-bold mb-2">Hapus Anggota</h4>
          <p class="text-sm text-red-300 mb-2">Perhatian: Menghapus anggota akan menghapus semua data absen dan fotonya.</p>
          <select id="anggotaNamaHapus" class="w-full bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none text-white mb-2"></select>
          <button id="btnHapusAnggota" class="px-4 py-2 rounded-xl w-full bg-red-600 hover:bg-red-700 font-semibold">Hapus</button>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button id="btnTutupAnggota" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Tutup</button>
      </div>
    </div>
  </div>

<script>
/* =======================
   Data & Storage Helpers
   ======================= */
const PRAYERS = ["subuh","dzuhur","ashar","maghrib","isya"];
const STATUS = ["hadir","alpha","sakit","izin"];

const sKey = {
  pin: "absen_pin",
  photos: "absen_foto_map",
  daily: "absen_daily",    // { 'YYYY-MM-DD': { 'nama': { subuh:'hadir', ... } } }
  groups: "absen_groups"
};

function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch(e){ return fallback; }
}
function saveJSON(key, value){
  try{
    localStorage.setItem(key, JSON.stringify(value));
  } catch(e){
    console.error("localStorage save error", e);
  }
}

function fmtDatePretty(d){
  const opt = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
  return d.toLocaleDateString("id-ID", opt);
}
function ymd(d){
  const year = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${year}-${m}-${day}`;
}

const DEFAULT_GROUPS = {
  non: ["ghifar","haqi","fadhlan","hunain","misbah","hilmy","zamil"],
  sekolah: ["hartono","alif","kevin","rayhan u","rayhan c","resa"]
};

/* =======================
   App State
   ======================= */
let isAdmin = false;
let currentDate = new Date();
let currentGroup = "non"; // 'non' or 'sekolah'
let showWeekly = false;

localStorage.setItem(sKey.pin, "p99"); 

let groups = loadJSON(sKey.groups, DEFAULT_GROUPS);
let dailyData = loadJSON(sKey.daily, {}); // all dates (local fallback)
let photoMap = loadJSON(sKey.photos, {}); // {nama: dataURL}
let adminPIN = localStorage.getItem(sKey.pin) || "p99"; 

let currentFireUnsub = null;

/* =======================
   UI Elements
   ======================= */
const datePicker = document.getElementById("datePicker");
const infoTanggal = document.getElementById("infoTanggal");
const infoMode = document.getElementById("infoMode");
const infoAnggota = document.getElementById("infoAnggota");

const btnViewer = document.getElementById("btnViewer");
const btnAdmin = document.getElementById("btnAdmin");

const btnHari = document.getElementById("btnHari");
const btnMinggu = document.getElementById("btnMinggu");

const tabNon = document.getElementById("tabNon");
const tabSekolah = document.getElementById("tabSekolah");

const panelNon = document.getElementById("panelNon");
const panelSekolah = document.getElementById("panelSekolah");

const tbodyNon = document.getElementById("tbodyNon");
const tbodySekolah = document.getElementById("tbodySekolah");

/* REKAP PER SHALAT DIHAPUS: rekapHarianGrid & btnResetHari */

const sectionHari = document.getElementById("sectionHari");
const sectionMinggu = document.getElementById("sectionMinggu");

const btnPrint = document.getElementById("btnPrint");
const weekStart = document.getElementById("weekStart");
const btnHitungMinggu = document.getElementById("btnHitungMinggu");
const tbodyWeekNon = document.getElementById("tbodyWeekNon");
const tbodyWeekSekolah = document.getElementById("tbodyWeekSekolah");
const sumNon = document.getElementById("sumNon");
const sumSekolah = document.getElementById("sumSekolah");

const rekapHarianAnggota = document.getElementById("rekapHarianAnggota");
const tbodyHarianAnggota = document.getElementById("tbodyHarianAnggota");

/* Admin Modal */
const adminModal = document.getElementById("adminModal");
const adminPinInput = document.getElementById("adminPinInput");
const confirmAdmin = document.getElementById("confirmAdmin");
const cancelAdmin = document.getElementById("cancelAdmin");

/* Foto Modal */
const fotoModal = document.getElementById("fotoModal");
const fotoAnggotaSelect = document.getElementById("fotoAnggotaSelect");
const fotoFile = document.getElementById("fotoFile");
const previewFoto = document.getElementById("previewFoto");
const btnSimpanFoto = document.getElementById("btnSimpanFoto");
const btnTutupFoto = document.getElementById("btnTutupFoto");
const btnHapusFoto = document.getElementById("btnHapusFoto");

/* Admin menu */
const mainFabContainer = document.getElementById("mainFabContainer");
const adminFab = document.getElementById("adminFab");
const fabToggle = document.getElementById("fabToggle");
const openFotoModal = document.getElementById("openFotoModal");
const exportData = document.getElementById("exportData");
const importData = document.getElementById("importData");
const changePin = document.getElementById("changePin");
const logoutAdmin = document.getElementById("logoutAdmin");

/* Anggota management */
const anggotaModal = document.getElementById("anggotaModal");
const openAnggotaModal = document.getElementById("openAnggotaModal");
const btnTutupAnggota = document.getElementById("btnTutupAnggota");
const anggotaNamaTambah = document.getElementById("anggotaNamaTambah");
const anggotaGrupTambah = document.getElementById("anggotaGrupTambah");
const btnTambahAnggota = document.getElementById("btnTambahAnggota");
const anggotaNamaHapus = document.getElementById("anggotaNamaHapus");
const btnHapusAnggota = document.getElementById("btnHapusAnggota");


/* =======================
   Rendering Functions
   ======================= */
function createMemberRow(nama, group){
  const dailyDataDate = dailyData[ymd(currentDate)] || {};
  const memberData = dailyDataDate[nama] || {};
  
  const row = document.createElement("tr");
  row.className = "row border-b border-white/5 last:border-0";
  row.innerHTML = `
    <td class="py-3 pr-3 text-white font-semibold flex items-center gap-3">
      <div class="avatar" id="avatar-${nama}">
        ${photoMap[nama] ? `<img src="${photoMap[nama]}" alt="${nama}">` : `<span>${nama[0].toUpperCase()}</span>`}
      </div>
      <span class="capitalize">${nama}</span>
    </td>
    ${PRAYERS.map(p => `
      <td class="py-3 pr-3">
        <div class="flex items-center gap-2">
          ${STATUS.map(s => `
            <button class="chip chip-${s} ${memberData[p] === s ? 'selected' : ''}" data-status="${s}" data-prayer="${p}" data-name="${nama}" data-group="${group}">${s}</button>
          `).join('')}
        </div>
      </td>
    `).join('')}
    <td class="py-3">
      ${photoMap[nama] ? `<a href="${photoMap[nama]}" target="_blank" class="text-xs text-sky-400 no-print hover:underline">Lihat Foto</a>` : ''}
    </td>
  `;
  return row;
}

function renderDailyTable(group){
  const members = groups[group];
  const tbody = group === "non" ? tbodyNon : tbodySekolah;
  tbody.innerHTML = '';
  members.forEach(member => {
    tbody.appendChild(createMemberRow(member, group));
  });
  updateDailyStatus();
}

function renderAllTables(){
  if(isAdmin){
    renderDailyTable("non");
    renderDailyTable("sekolah");
  }
  renderDailyMemberSummary(); // hanya rekap per anggota (format baru)
}

/* ====== REKAP PER SHALAT DIHAPUS SESUAI ARAHAN ====== */

/* NEW: Rekap Harian per Anggota -> menampilkan status per shalat (badge berwarna) */
function renderDailyMemberSummary(){
  const dailyDataDate = dailyData[ymd(currentDate)] || {};
  const allMembers = [...groups.non, ...groups.sekolah].sort();
  
  let html = '';
  allMembers.forEach(member => {
    const memberData = dailyDataDate[member] || {};
    const tdCells = PRAYERS.map(p => {
      const status = memberData[p] || 'alpha'; // default alpha bila kosong
      return `<td class="py-3 pr-3"><span class="badge badge-${status} capitalize">${status}</span></td>`;
    }).join('');
    html += `
      <tr class="border-b border-white/5 last:border-0">
        <td class="py-3 pr-3 font-semibold capitalize">${member}</td>
        ${tdCells}
      </tr>
    `;
  });
  tbodyHarianAnggota.innerHTML = html;

  // Update info total anggota
  infoAnggota.textContent = `${groups.non.length + groups.sekolah.length} Anggota`;
}

function renderWeeklySummary(){
  const start = new Date(weekStart.value);
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  const weeklyTotals = { non: {}, sekolah: {} };
  
  groups.non.forEach(m => weeklyTotals.non[m] = { hadir:0, alpha:0, sakit:0, izin:0 });
  groups.sekolah.forEach(m => weeklyTotals.sekolah[m] = { hadir:0, alpha:0, sakit:0, izin:0 });
  
  for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
    const dailyDataDate = dailyData[ymd(d)] || {};
    [...groups.non, ...groups.sekolah].forEach(m => {
      const memberData = dailyDataDate[m] || {};
      PRAYERS.forEach(p => {
        const status = memberData[p] || "alpha";
        if(groups.non.includes(m)){
          weeklyTotals.non[m][status]++;
        } else {
          weeklyTotals.sekolah[m][status]++;
        }
      });
    });
  }

  let htmlNon = '';
  let sumNonTotal = 0;
  groups.non.forEach(m => {
    sumNonTotal += weeklyTotals.non[m].hadir;
    htmlNon += `
      <tr class="border-b border-white/5 last:border-0">
        <td class="py-3 pr-3 font-semibold capitalize">${m}</td>
        <td class="py-3 pr-3">${weeklyTotals.non[m].hadir}</td>
        <td class="py-3 pr-3">${weeklyTotals.non[m].alpha}</td>
        <td class="py-3 pr-3">${weeklyTotals.non[m].sakit}</td>
        <td class="py-3 pr-3">${weeklyTotals.non[m].izin}</td>
      </tr>
    `;
  });
  tbodyWeekNon.innerHTML = htmlNon;
  sumNon.textContent = `Total Hadir: ${sumNonTotal}`;
  
  let htmlSekolah = '';
  let sumSekolahTotal = 0;
  groups.sekolah.forEach(m => {
    sumSekolahTotal += weeklyTotals.sekolah[m].hadir;
    htmlSekolah += `
      <tr class="border-b border-white/5 last:border-0">
        <td class="py-3 pr-3 font-semibold capitalize">${m}</td>
        <td class="py-3 pr-3">${weeklyTotals.sekolah[m].hadir}</td>
        <td class="py-3 pr-3">${weeklyTotals.sekolah[m].alpha}</td>
        <td class="py-3 pr-3">${weeklyTotals.sekolah[m].sakit}</td>
        <td class="py-3 pr-3">${weeklyTotals.sekolah[m].izin}</td>
      </tr>
    `;
  });
  tbodyWeekSekolah.innerHTML = htmlSekolah;
  sumSekolah.textContent = `Total Hadir: ${sumSekolahTotal}`;
}

function updateDailyStatus(){
  const dailyDataDate = dailyData[ymd(currentDate)] || {};
  document.querySelectorAll('.chip').forEach(chip => {
    const { name, prayer, status } = chip.dataset;
    if (dailyDataDate[name] && dailyDataDate[name][prayer] === status) {
      chip.classList.add('selected');
    } else {
      chip.classList.remove('selected');
    }
  });
}

function updateUI(){
  infoTanggal.textContent = fmtDatePretty(currentDate);
  datePicker.value = ymd(currentDate);
  infoAnggota.textContent = `${groups.non.length + groups.sekolah.length} Anggota`;

  sectionHari.classList.toggle('hidden', showWeekly);
  sectionMinggu.classList.toggle('hidden', !showWeekly);
  btnHari.classList.toggle('active', !showWeekly);
  btnMinggu.classList.toggle('active', showWeekly);

  if(!showWeekly){
    const noViewerElements = document.querySelectorAll('.no-viewer');
    noViewerElements.forEach(el => {
        if (!isAdmin) { el.classList.add('hidden'); }
        else { el.classList.remove('hidden'); }
    });

    if (isAdmin) {
      panelNon.classList.toggle('hidden', currentGroup !== 'non');
      panelSekolah.classList.toggle('hidden', currentGroup !== 'sekolah');
      tabNon.classList.toggle('active', currentGroup === 'non');
      tabSekolah.classList.toggle('active', currentGroup === 'sekolah');
    } else {
      panelNon.classList.add('hidden');
      panelSekolah.classList.add('hidden');
    }
  }

  btnViewer.classList.toggle('active', !isAdmin);
  btnAdmin.classList.toggle('active', isAdmin);
  infoMode.textContent = isAdmin ? 'Admin (bisa edit)' : 'Viewer (hanya lihat)';

  document.querySelectorAll('.chip').forEach(chip => {
    chip.disabled = !isAdmin;
    chip.style.pointerEvents = isAdmin ? 'auto' : 'none';
    chip.style.opacity = isAdmin ? 1 : 0.6;
    chip.style.cursor = isAdmin ? 'pointer' : 'default';
  });

  mainFabContainer.classList.toggle('hidden', !isAdmin);
  adminFab.classList.add('hidden');
}

/* =======================
   Event Listeners
   ======================= */
btnViewer.addEventListener('click', () => { isAdmin = false; updateUI(); renderAllTables(); });
btnAdmin.addEventListener('click', () => { adminModal.style.display = 'flex'; });

confirmAdmin.addEventListener('click', () => {
  if(adminPinInput.value === adminPIN){
    isAdmin = true;
    adminModal.style.display = 'none';
    adminPinInput.value = '';
    updateUI();
  } else {
    alert("PIN salah!");
    adminPinInput.value = '';
  }
});
cancelAdmin.addEventListener('click', () => {
  adminModal.style.display = 'none';
  adminPinInput.value = '';
});
forgotPin.addEventListener('click', () => {
  alert("Hubungi ketua bidang untuk reset PIN.\nPIN default: p99");
});

btnHari.addEventListener('click', () => { showWeekly = false; updateUI(); renderAllTables(); });
btnMinggu.addEventListener('click', () => { showWeekly = true; updateUI(); renderWeeklySummary(); });

tabNon.addEventListener('click', () => { currentGroup = 'non'; updateUI(); });
tabSekolah.addEventListener('click', () => { currentGroup = 'sekolah'; updateUI(); });

datePicker.addEventListener('change', (e) => {
  if (currentFireUnsub && typeof currentFireUnsub === 'function') {
    try { currentFireUnsub(); } catch(err){ console.warn(err); }
    currentFireUnsub = null;
  }
  currentDate = new Date(e.target.value);
  updateUI();
  renderAllTables();

  const dateStr = ymd(currentDate);
  if (window.firebaseHelpers && window.firebaseHelpers.watchDailyDoc) {
    currentFireUnsub = window.firebaseHelpers.watchDailyDoc(dateStr, (data) => {
      dailyData[dateStr] = data || {};
      renderAllTables();
    });
  }
});

document.addEventListener('click', (e) => {
  if(e.target.classList.contains('chip') && isAdmin){
    const { name, prayer, status } = e.target.dataset;
    const dateStr = ymd(currentDate);

    dailyData[dateStr] = dailyData[dateStr] || {};
    dailyData[dateStr][name] = dailyData[dateStr][name] || {};
    dailyData[dateStr][name][prayer] = status;

    saveJSON(sKey.daily, dailyData);

    if (window.firebaseHelpers && window.firebaseHelpers.saveDailyDoc) {
      window.firebaseHelpers.saveDailyDoc(dateStr, dailyData[dateStr]).catch(err => console.error(err));
      document.getElementById('storageNote').textContent = "Data disimpan ke Firestore (online) · Local backup aktif";
    }

    renderAllTables();
  }
});

/* RESETER HARIAN DIHILANGKAN BERSAMA KARTU REKAP PER SHALAT */

/* Weekly calculation */
btnHitungMinggu.addEventListener('click', renderWeeklySummary);

/* Print */
btnPrint.addEventListener('click', () => { window.print(); });

/* Admin FAB */
fabToggle.addEventListener('click', () => {
  adminFab.classList.toggle('hidden');
});

/* Manage Photos */
openFotoModal.addEventListener('click', () => {
  const allMembers = [...groups.non, ...groups.sekolah];
  fotoAnggotaSelect.innerHTML = allMembers.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
  fotoModal.style.display = 'flex';
  const initialName = fotoAnggotaSelect.value;
  if(photoMap[initialName]){
    previewFoto.innerHTML = `<img src="${photoMap[initialName]}" class="w-full h-full object-contain" />`;
  } else {
    previewFoto.innerHTML = `Pratinjau foto akan muncul di sini`;
  }
});
fotoAnggotaSelect.addEventListener('change', () => {
  const selectedName = fotoAnggotaSelect.value;
  if(photoMap[selectedName]){
    previewFoto.innerHTML = `<img src="${photoMap[selectedName]}" class="w-full h-full object-contain" />`;
  } else {
    previewFoto.innerHTML = `Pratinjau foto akan muncul di sini`;
  }
});
fotoFile.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (event) => {
      previewFoto.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-contain" />`;
    };
    reader.readAsDataURL(file);
  }
});
btnSimpanFoto.addEventListener('click', () => {
  const selectedName = fotoAnggotaSelect.value;
  const file = fotoFile.files[0];
  if(selectedName && file){
    const reader = new FileReader();
    reader.onload = (event) => {
      photoMap[selectedName] = event.target.result;
      saveJSON(sKey.photos, photoMap);
      alert(`Foto untuk ${selectedName.toUpperCase()} berhasil disimpan.`);
      updateUI();
      renderAllTables();
    };
    reader.readAsDataURL(file);
  } else {
    alert("Pilih anggota dan foto terlebih dahulu.");
  }
});
btnHapusFoto.addEventListener('click', () => {
  const selectedName = fotoAnggotaSelect.value;
  if(confirm(`Yakin ingin menghapus foto ${selectedName.toUpperCase()}?`)){
    delete photoMap[selectedName];
    saveJSON(sKey.photos, photoMap);
    alert("Foto berhasil dihapus.");
    previewFoto.innerHTML = `Pratinjau foto akan muncul di sini`;
    updateUI();
    renderAllTables();
  }
});
btnTutupFoto.addEventListener('click', () => {
  fotoModal.style.display = 'none';
  fotoFile.value = '';
});

/* Export/Import */
exportData.addEventListener('click', () => {
  const data = JSON.stringify({ dailyData, photoMap, adminPIN, groups }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `absen_data_${ymd(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(url);
});
importData.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          dailyData = importedData.dailyData || {};
          photoMap = importedData.photoMap || {};
          adminPIN = importedData.adminPIN || adminPIN;
          groups = importedData.groups || DEFAULT_GROUPS;
          saveJSON(sKey.daily, dailyData);
          saveJSON(sKey.photos, photoMap);
          localStorage.setItem(sKey.pin, adminPIN);
          saveJSON(sKey.groups, groups);

          if (window.firebaseHelpers && window.firebaseHelpers.saveAllDaily) {
            try {
              await window.firebaseHelpers.saveAllDaily(dailyData);
              document.getElementById('storageNote').textContent = "Data disimpan ke Firestore (online) · Local backup aktif";
            } catch(err){ console.error(err); }
          }

          alert('Data berhasil diimpor.');
          renderAllTables();
          updateAnggotaSelects();
        } catch (error) {
          alert('Gagal mengimpor data. File tidak valid.');
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
});

/* Change PIN */
changePin.addEventListener('click', () => {
  const newPin = prompt("Masukkan PIN baru:");
  if(newPin){
    adminPIN = newPin;
    localStorage.setItem(sKey.pin, adminPIN);
    alert("PIN berhasil diubah!");
  }
});
logoutAdmin.addEventListener('click', () => {
  isAdmin = false;
  updateUI();
  alert("Anda telah keluar dari mode Admin.");
});

/* Anggota Modal & Management */
openAnggotaModal.addEventListener('click', () => {
  updateAnggotaSelects();
  anggotaModal.style.display = 'flex';
});
btnTutupAnggota.addEventListener('click', () => {
  anggotaModal.style.display = 'none';
  anggotaNamaTambah.value = '';
});

btnTambahAnggota.addEventListener('click', () => {
  const nama = anggotaNamaTambah.value.trim().toLowerCase();
  const grup = anggotaGrupTambah.value;
  if(nama === ""){
    alert("Nama tidak boleh kosong.");
    return;
  }
  const allMembers = [...groups.non, ...groups.sekolah];
  if(allMembers.includes(nama)){
    alert("Anggota dengan nama ini sudah ada.");
    return;
  }
  groups[grup].push(nama);
  saveJSON(sKey.groups, groups);
  alert(`Anggota "${nama}" berhasil ditambahkan ke grup "${grup}".`);
  anggotaNamaTambah.value = '';
  updateUI();
  renderAllTables();
  updateAnggotaSelects();
});

btnHapusAnggota.addEventListener('click', () => {
  const nama = anggotaNamaHapus.value;
  if(!nama){
    alert("Pilih anggota yang akan dihapus.");
    return;
  }
  if(confirm(`Yakin ingin menghapus anggota "${nama}"? Semua data absen dan fotonya akan dihapus.`)){
    for (const grup in groups) {
      const index = groups[grup].indexOf(nama);
      if(index > -1) {
        groups[grup].splice(index, 1);
        break;
      }
    }
    for (const date in dailyData) {
      delete dailyData[date][nama];
    }
    delete photoMap[nama];

    saveJSON(sKey.groups, groups);
    saveJSON(sKey.daily, dailyData);
    saveJSON(sKey.photos, photoMap);

    if (window.firebaseHelpers && window.firebaseHelpers.saveAllDaily) {
      window.firebaseHelpers.saveAllDaily(dailyData).catch(err => console.error(err));
      document.getElementById('storageNote').textContent = "Data disimpan ke Firestore (online) · Local backup aktif";
    }
    
    alert(`Anggota "${nama}" berhasil dihapus.`);
    updateUI();
    renderAllTables();
    updateAnggotaSelects();
  }
});

function updateAnggotaSelects(){
  const allMembers = [...groups.non, ...groups.sekolah].sort();
  const anggotaNamaHapusEl = document.getElementById("anggotaNamaHapus");
  const fotoAnggotaSelectEl = document.getElementById("fotoAnggotaSelect");
  if(anggotaNamaHapusEl){
    anggotaNamaHapusEl.innerHTML = allMembers.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
  }
  if(fotoAnggotaSelectEl){
    fotoAnggotaSelectEl.innerHTML = allMembers.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');
  }
}

/* =======================
   Initial Call
   ======================= */
window.addEventListener('load', async () => {
  datePicker.value = ymd(currentDate);
  updateUI();
  renderAllTables();
  updateAnggotaSelects();

  try {
    const dateStr = ymd(currentDate);
    if (window.firebaseHelpers && window.firebaseHelpers.watchDailyDoc) {
      currentFireUnsub = window.firebaseHelpers.watchDailyDoc(dateStr, (data) => {
        dailyData[dateStr] = data || {};
        renderAllTables();
        document.getElementById('storageNote').textContent = "Data disimpan ke Firestore (online) · Local backup aktif";
      });
    } else {
      document.getElementById('storageNote').textContent = "Data disimpan lokal (offline).";
    }
  } catch(e) {
    console.error(e);
    document.getElementById('storageNote').textContent = "Data disimpan lokal (offline).";
  }
});
</script>
</body>
</html>
